name: Release Helm Chart

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Helm
        run: |
          curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
          chmod 700 get_helm.sh
          ./get_helm.sh

      - name: Find Chart.yaml and package
        run: |
          echo "=== Ð˜Ð©Ð•Ðœ Chart.yaml ==="
          CHART_PATH=$(find . -name "Chart.yaml" | head -1)
          
          if [ -z "$CHART_PATH" ]; then
            echo "âŒ Chart.yaml ÐÐ• ÐÐÐ™Ð”Ð•Ð!"
            echo "Ð¡Ð¾Ð·Ð´Ð°ÑŽ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Chart.yaml..."
            mkdir -p helm-chart
            cat > helm-chart/Chart.yaml << 'EOF'
apiVersion: v2
name: k8s-access-manager
description: Kubernetes RBAC Access Manager
type: application
version: 0.1.0
appVersion: "0.1.0"
EOF
            CHART_PATH="./helm-chart/Chart.yaml"
          fi
          
          echo "âœ… ÐÐ°Ð¹Ð´ÐµÐ½ Chart.yaml: $CHART_PATH"
          CHART_DIR=$(dirname "$CHART_PATH")
          echo "ðŸ“ Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ Ñ‡Ð°Ñ€Ñ‚Ð°: $CHART_DIR"
          
          # ÐŸÐ°ÐºÐµÑ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¸Ð· Ð½Ð°Ð¹Ð´ÐµÐ½Ð½Ð¾Ð¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
          helm package "$CHART_DIR" --version ${GITHUB_REF#refs/tags/v}
          
          echo "=== Ð¡ÐžÐ—Ð”ÐÐÐÐ«Ð• ÐŸÐÐšÐ•Ð¢Ð« ==="
          ls -la *.tgz

      - name: Generate repository index
        run: |
          helm repo index . --url https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}
          echo "=== INDEX.YAML ==="
          cat index.yaml

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          force_orphan: true
